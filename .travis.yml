language: node_js

node_js:
  - "stable"

cache:
  directories:
    - node_modules

before_install:
    - sed -nE 's/^[ \\t]*"version": "([0-9]{1,}\\.[0-9]{1,}\\.)[0-9x]{1,}",$/\\1/p' package.json; 
    - git describe --abbrev=0
    - sed -E 's/^v([0-9]{1,}\\.[0-9]{1,}\\.)([0-9]{1,})$/\\1 \\2/g';
    - tr "\\n" " "
    - awk '{printf($1==$2?"v"$2$3+1:"v"$1"0")}'
    - xargs -I {} git tag -a {} -m "{}"

script:
  - npm run build:prod

deploy:
- provider: npm
    email: $NPM_EMAIL
    api_key: $NPM_TOKEN
    on:
      branch: master
- provider: script
    script: git push --tags
    skip_cleanup: true
    on:
      branch: master    

notifications:
  email:
    on_failure: change